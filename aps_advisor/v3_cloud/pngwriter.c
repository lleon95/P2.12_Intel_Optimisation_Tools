#include "png.h"
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "pngwriter.h"


/* Datatype for RGB pixel */
typedef struct {
    uint8_t red;
    uint8_t green;
    uint8_t blue;
} pixel_t;


static int heat_colormap[258][3] = {
    {59, 76, 192}, {59, 76, 192}, {60, 78, 194}, {61, 80, 195},
    {62, 81, 197}, {64, 83, 198}, {65, 85, 200}, {66, 87, 201},
    {67, 88, 203}, {68, 90, 204}, {69, 92, 206}, {71, 93, 207},
    {72, 95, 209}, {73, 97, 210}, {74, 99, 211}, {75, 100, 213},
    {77, 102, 214}, {78, 104, 215}, {79, 105, 217}, {80, 107, 218},
    {82, 109, 219}, {83, 110, 221}, {84, 112, 222}, {85, 114, 223},
    {87, 115, 224}, {88, 117, 225}, {89, 119, 227}, {90, 120, 228},
    {92, 122, 229}, {93, 124, 230}, {94, 125, 231}, {96, 127, 232},
    {97, 129, 233}, {98, 130, 234}, {100, 132, 235}, {101, 133, 236},
    {102, 135, 237}, {103, 137, 238}, {105, 138, 239}, {106, 140, 240},
    {107, 141, 240}, {109, 143, 241}, {110, 144, 242}, {111, 146, 243},
    {113, 147, 244}, {114, 149, 244}, {116, 150, 245}, {117, 152, 246},
    {118, 153, 246}, {120, 155, 247}, {121, 156, 248}, {122, 157, 248},
    {124, 159, 249}, {125, 160, 249}, {127, 162, 250}, {128, 163, 250},
    {129, 164, 251}, {131, 166, 251}, {132, 167, 252}, {133, 168, 252},
    {135, 170, 252}, {136, 171, 253}, {138, 172, 253}, {139, 174, 253},
    {140, 175, 254}, {142, 176, 254}, {143, 177, 254}, {145, 179, 254},
    {146, 180, 254}, {147, 181, 255}, {149, 182, 255}, {150, 183, 255},
    {152, 185, 255}, {153, 186, 255}, {154, 187, 255}, {156, 188, 255},
    {157, 189, 255}, {158, 190, 255}, {160, 191, 255}, {161, 192, 255},
    {163, 193, 255}, {164, 194, 254}, {165, 195, 254}, {167, 196, 254},
    {168, 197, 254}, {169, 198, 254}, {171, 199, 253}, {172, 200, 253},
    {173, 201, 253}, {175, 202, 252}, {176, 203, 252}, {177, 203, 252},
    {179, 204, 251}, {180, 205, 251}, {181, 206, 250}, {183, 207, 250},
    {184, 207, 249}, {185, 208, 249}, {186, 209, 248}, {188, 209, 247},
    {189, 210, 247}, {190, 211, 246}, {191, 211, 246}, {193, 212, 245},
    {194, 213, 244}, {195, 213, 243}, {196, 214, 243}, {198, 214, 242},
    {199, 215, 241}, {200, 215, 240}, {201, 216, 239}, {202, 216, 239},
    {204, 217, 238}, {205, 217, 237}, {206, 217, 236}, {207, 218, 235},
    {208, 218, 234}, {209, 218, 233}, {210, 219, 232}, {211, 219, 231},
    {212, 219, 230}, {214, 220, 229}, {215, 220, 228}, {216, 220, 227},
    {217, 220, 225}, {218, 220, 224}, {219, 220, 223}, {220, 221, 222},
    {221, 221, 221}, {222, 220, 219}, {223, 220, 218}, {224, 219, 216},
    {225, 219, 215}, {226, 218, 214}, {227, 218, 212}, {228, 217, 211},
    {229, 216, 209}, {230, 216, 208}, {231, 215, 206}, {232, 215, 205},
    {233, 214, 203}, {233, 213, 202}, {234, 212, 200}, {235, 212, 199},
    {236, 211, 197}, {237, 210, 196}, {237, 209, 194}, {238, 208, 193},
    {239, 208, 191}, {239, 207, 190}, {240, 206, 188}, {240, 205, 187},
    {241, 204, 185}, {242, 203, 183}, {242, 202, 182}, {243, 201, 180},
    {243, 200, 179}, {243, 199, 177}, {244, 198, 176}, {244, 197, 174},
    {245, 196, 173}, {245, 195, 171}, {245, 194, 169}, {246, 193, 168},
    {246, 192, 166}, {246, 190, 165}, {246, 189, 163}, {247, 188, 161},
    {247, 187, 160}, {247, 186, 158}, {247, 184, 157}, {247, 183, 155},
    {247, 182, 153}, {247, 181, 152}, {247, 179, 150}, {247, 178, 149},
    {247, 177, 147}, {247, 175, 146}, {247, 174, 144}, {247, 172, 142},
    {247, 171, 141}, {247, 170, 139}, {247, 168, 138}, {247, 167, 136},
    {247, 165, 135}, {246, 164, 133}, {246, 162, 131}, {246, 161, 130},
    {246, 159, 128}, {245, 158, 127}, {245, 156, 125}, {245, 155, 124},
    {244, 153, 122}, {244, 151, 121}, {243, 150, 119}, {243, 148, 117},
    {242, 147, 116}, {242, 145, 114}, {241, 143, 113}, {241, 142, 111},
    {240, 140, 110}, {240, 138, 108}, {239, 136, 107}, {239, 135, 105},
    {238, 133, 104}, {237, 131, 102}, {237, 129, 101}, {236, 128, 99},
    {235, 126, 98}, {235, 124, 96}, {234, 122, 95}, {233, 120, 94},
    {232, 118, 92}, {231, 117, 91}, {230, 115, 89}, {230, 113, 88},
    {229, 111, 86}, {228, 109, 85}, {227, 107, 84}, {226, 105, 82},
    {225, 103, 81}, {224, 101, 79}, {223, 99, 78}, {222, 97, 77},
    {221, 95, 75}, {220, 93, 74}, {219, 91, 73}, {218, 89, 71},
    {217, 87, 70}, {215, 85, 69}, {214, 82, 67}, {213, 80, 66},
    {212, 78, 65}, {211, 76, 64}, {210, 74, 62}, {208, 71, 61},
    {207, 69, 60}, {206, 67, 59}, {204, 64, 57}, {203, 62, 56},
    {202, 59, 55}, {200, 57, 54}, {199, 54, 53}, {198, 52, 51},
    {196, 49, 50}, {195, 46, 49}, {193, 43, 48}, {192, 40, 47},
    {191, 37, 46}, {189, 34, 44}, {188, 30, 43}, {186, 26, 42},
    {185, 22, 41}, {183, 17, 40}, {182, 11, 39}, {180, 4, 38}, {0,0,255}, {255,0,0}
};


/*
 * Save the two dimensional array as a png image
 * Arguments:
 *   double *data - pointer to an array of nx * ny values
 *   int nx       - number of COLUMNS to be written
 *   int ny       - number of ROWS to be written
 *   char *fname  - name of the picture
 *   char lang    - either 'c' or 'f' denoting the memory
 *                  layout. That is, if 'f' is given, then rows
 *                  and columns are swapped.
 */


int save_png(double *data, const int height, const int width,
             const char *fname)//, const char lang)
{
    FILE *fp;
    png_structp pngstruct_ptr = NULL;
    png_infop pnginfo_ptr = NULL;
    png_byte **row_pointers = NULL;
    int i, j;
    int end_loop = height;    // added
    /* Default return status is failure */
    int status = -1;

    int pixel_size = 3;
    int depth = 8;

    /* Open the file and initialize the png library.
     * Note that in error cases we jump to clean up
     * parts in the end of this function using goto. */
    fp = fopen(fname, "wb");
    if (fp == NULL) {
        goto fopen_failed;
    }

    pngstruct_ptr =
        png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);

    if (pngstruct_ptr == NULL) {
        goto pngstruct_create_failed;
    }

    pnginfo_ptr = png_create_info_struct(pngstruct_ptr);

    if (pnginfo_ptr == NULL) {
        goto pnginfo_create_failed;
    }

    if (setjmp(png_jmpbuf(pngstruct_ptr))) {
        goto setjmp_failed;
    }

    png_set_IHDR(pngstruct_ptr, pnginfo_ptr, (size_t) width,
                 (size_t) height, depth, PNG_COLOR_TYPE_RGB,
                 PNG_INTERLACE_NONE,
                 PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT);

    row_pointers = png_malloc(pngstruct_ptr, height * sizeof(png_byte *));

    for (i = 0; i < end_loop; i++) {    // replaced
        png_byte *row = png_malloc(pngstruct_ptr,
                                   sizeof(uint8_t) * width * pixel_size);
        row_pointers[i] = row;
        /* Branch according to the C memory layout */ // __assume_aligned(data, 64);
		#pragma omp simd
		#pragma vector always nodynamic_align
		for (j = 0; j < width; j++) {
			//pixel_t pixel;
			/* Scale the values so that values between 0 and
			* 100 degrees are mapped to values between 0 and 255 */
			//cmap(data[j + i * width], 2.55, 0.0, &pixel);

			int ival = (int)(data[j + i * width] * 2.55);
			
			if (ival < 0) {
				/* Colder than colorscale, substitute blue */
				ival = 256;
			}
			else if (ival > 255) {
				/* Hotter than colormap, substitute red */
				ival = 257;
			}
			row[3*j]   = heat_colormap[ival][0];
			row[3*j+1] = heat_colormap[ival][1];
			row[3*j+2] = heat_colormap[ival][2];
		}
    }

    png_init_io(pngstruct_ptr, fp);
    png_set_rows(pngstruct_ptr, pnginfo_ptr, row_pointers);
    png_write_png(pngstruct_ptr, pnginfo_ptr,
                  PNG_TRANSFORM_IDENTITY, NULL);

    status = 0;

    for (i = 0; i < height; i++) {    
        png_free(pngstruct_ptr, row_pointers[i]);
    }
    png_free(pngstruct_ptr, row_pointers);

    /* Cleanup with labels */
setjmp_failed:
pnginfo_create_failed:
    png_destroy_write_struct(&pngstruct_ptr, &pnginfo_ptr);
pngstruct_create_failed:
    fclose(fp);
fopen_failed:
    return status;
}
 
/*
static int heat_colormap[3][258] = {
	{59, 59, 60, 61, 62, 64, 65, 66, 67, 68, 69, 71, 72, 73, 74, 75, 77, 78, 79, 80, 82, 83, 84, 85, 87, 88, 89, 90, 92, 93, 94, 96, 97, 98, 100, 101, 102, 103, 105, 106, 107, 109, 110, 111, 113, 114, 116, 117, 118, 120, 121, 122, 124, 125, 127, 128, 129, 131, 132, 133, 135, 136, 138, 139, 140, 142, 143, 145, 146, 147, 149, 150, 152, 153, 154, 156, 157, 158, 160, 161, 163, 164, 165, 167, 168, 169, 171, 172, 173, 175, 176, 177, 179, 180, 181, 183, 184, 185, 186, 188, 189, 190, 191, 193, 194, 195, 196, 198, 199, 200, 201, 202, 204, 205, 206, 207, 208, 209, 210, 211, 212, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 233, 234, 235, 236, 237, 237, 238, 239, 239, 240, 240, 241, 242, 242, 243, 243, 243, 244, 244, 245, 245, 245, 246, 246, 246, 246, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 246, 246, 246, 246, 245, 245, 245, 244, 244, 243, 243, 242, 242, 241, 241, 240, 240, 239, 239, 238, 237, 237, 236, 235, 235, 234, 233, 232, 231, 230, 230, 229, 228, 227, 226, 225, 224, 223, 222, 221, 220, 219, 218, 217, 215, 214, 213, 212, 211, 210, 208, 207, 206, 204, 203, 202, 200, 199, 198, 196, 195, 193, 192, 191, 189, 188, 186, 185, 183, 182, 180, 0, 255},
	{76, 76, 78, 80, 81, 83, 85, 87, 88, 90, 92, 93, 95, 97, 99, 100, 102, 104, 105, 107, 109, 110, 112, 114, 115, 117, 119, 120, 122, 124, 125, 127, 129, 130, 132, 133, 135, 137, 138, 140, 141, 143, 144, 146, 147, 149, 150, 152, 153, 155, 156, 157, 159, 160, 162, 163, 164, 166, 167, 168, 170, 171, 172, 174, 175, 176, 177, 179, 180, 181, 182, 183, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 203, 204, 205, 206, 207, 207, 208, 209, 209, 210, 211, 211, 212, 213, 213, 214, 214, 215, 215, 216, 216, 217, 217, 217, 218, 218, 218, 219, 219, 219, 220, 220, 220, 220, 220, 220, 221, 221, 220, 220, 219, 219, 218, 218, 217, 216, 216, 215, 215, 214, 213, 212, 212, 211, 210, 209, 208, 208, 207, 206, 205, 204, 203, 202, 201, 200, 199, 198, 197, 196, 195, 194, 193, 192, 190, 189, 188, 187, 186, 184, 183, 182, 181, 179, 178, 177, 175, 174, 172, 171, 170, 168, 167, 165, 164, 162, 161, 159, 158, 156, 155, 153, 151, 150, 148, 147, 145, 143, 142, 140, 138, 136, 135, 133, 131, 129, 128, 126, 124, 122, 120, 118, 117, 115, 113, 111, 109, 107, 105, 103, 101, 99, 97, 95, 93, 91, 89, 87, 85, 82, 80, 78, 76, 74, 71, 69, 67, 64, 62, 59, 57, 54, 52, 49, 46, 43, 40, 37, 34, 30, 26, 22, 17, 11, 4, 0, 0},
	{192, 192, 194, 195, 197, 198, 200, 201, 203, 204, 206, 207, 209, 210, 211, 213, 214, 215, 217, 218, 219, 221, 222, 223, 224, 225, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 240, 241, 242, 243, 244, 244, 245, 246, 246, 247, 248, 248, 249, 249, 250, 250, 251, 251, 252, 252, 252, 253, 253, 253, 254, 254, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 254, 254, 253, 253, 253, 252, 252, 252, 251, 251, 250, 250, 249, 249, 248, 247, 247, 246, 246, 245, 244, 243, 243, 242, 241, 240, 239, 239, 238, 237, 236, 235, 234, 233, 232, 231, 230, 229, 228, 227, 225, 224, 223, 222, 221, 219, 218, 216, 215, 214, 212, 211, 209, 208, 206, 205, 203, 202, 200, 199, 197, 196, 194, 193, 191, 190, 188, 187, 185, 183, 182, 180, 179, 177, 176, 174, 173, 171, 169, 168, 166, 165, 163, 161, 160, 158, 157, 155, 153, 152, 150, 149, 147, 146, 144, 142, 141, 139, 138, 136, 135, 133, 131, 130, 128, 127, 125, 124, 122, 121, 119, 117, 116, 114, 113, 111, 110, 108, 107, 105, 104, 102, 101, 99, 98, 96, 95, 94, 92, 91, 89, 88, 86, 85, 84, 82, 81, 79, 78, 77, 75, 74, 73, 71, 70, 69, 67, 66, 65, 64, 62, 61, 60, 59, 57, 56, 55, 54, 53, 51, 50, 49, 48, 47, 46, 44, 43, 42, 41, 40, 39, 38, 255, 0}
};
*/
